<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>WhatsApp Reader Pro</title>
    <style>
        body { font-family: -apple-system, Segoe UI, Roboto, sans-serif; background: #e5ddd5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px; background: #075e54; color: white; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #search { padding: 10px; border-radius: 5px; border: none; font-size: 16px; width: 100%; box-sizing: border-box; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: white; padding: 10px; border-radius: 8px; max-width: 85%; align-self: flex-start; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .stk { max-width: 200px; max-height: 200px; display: block; margin-top: 8px; border-radius: 5px; }
        .meta { font-size: 0.75em; color: #888; margin-bottom: 4px; display: block; }
        .stats { font-size: 0.8em; opacity: 0.8; }
    </style>
</head>
<body>
    <header>
        <div class="stats" id="status">Cargando 120,000 mensajes...</div>
        <input type="text" id="search" placeholder="Escribí para buscar en el historial...">
    </header>
    <div id="chat-container"></div>

    <script>
        const container = document.getElementById('chat-container');
        const status = document.getElementById('status');
        const searchInput = document.getElementById('search');
        let allMessages = [];

        async function init() {
            try {
                const response = await fetch('chat.txt');
                const text = await response.text();
                allMessages = text.split('\n').filter(line => line.trim() !== '');
                status.innerText = `Chat cargado: ${allMessages.length.toLocaleString()} mensajes.`;
                render(allMessages.slice(-500)); // Mostramos los últimos 500 para empezar
            } catch (e) {
                status.innerText = "Error: No se encontró chat.txt";
            }
        }

        function render(msgs) {
            container.innerHTML = '';
            const frag = document.createDocumentFragment();
            msgs.forEach(line => {
                const div = document.createElement('div');
                div.className = 'msg';
                
                if (line.includes('(archivo adjunto)')) {
                    // Extraer nombre del archivo entre el último ": " y el " (archivo adjunto)"
                    const parts = line.split(': ');
                    const filePart = parts[parts.length - 1].split(' (archivo adjunto)')[0].trim();
                    div.innerHTML = `<span class="meta">${line}</span><img src="${filePart}" class="stk" onerror="this.alt='Media: ${filePart}'; this.style.border='1px solid #ccc';">`;
                } else {
                    div.innerText = line;
                }
                frag.appendChild(div);
            });
            container.appendChild(frag);
            container.scrollTop = container.scrollHeight;
        }

        searchInput.oninput = () => {
            const term = searchInput.value.toLowerCase();
            if (term.length < 3) return; // Esperar a que escriba 3 letras
            const filtered = allMessages.filter(m => m.toLowerCase().includes(term)).slice(0, 300);
            render(filtered);
            status.innerText = `Resultados de búsqueda: ${filtered.length}`;
        };

        init();
    </script>
</body>
</html>